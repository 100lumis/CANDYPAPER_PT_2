<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Candy Crush Leaderboard Edition</title>
  <style>
    
  </style>
</head>
<body>
  <div class="header">
    <h1>Candypaper</h1>
    <div class="scoreBoard">
      <h2>Hanki 200 pistett√§!</h2>
      <h2>Pisteet: <span id="score">0</span></h2>
      <h2>Liikkeet j√§ljell√§: <span id="moves">40</span></h2>
    </div>
  </div>

  <h2 id="leaderboardTitle">Leaderboard</h2>
  <table id="leaderboardTable">
    <thead>
      <tr>
        <th>Nimi</th>
        <th>Pisteet</th>
        <th>Aika (s)</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>
  <button id="nappi" onclick="clearLeaderboard()">Tyhjenn√§ leaderboard</button>

  <div class="grid"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

  <script src="score-utils.js"></script>

  <script>
    let playerName = "";
    let leaderboard = [];
    let playerEntry = null;
    let gameStartTime = Date.now();

    window.addEventListener("load", () => {
      playerName = prompt("Anna nimesi:") || "Anonyymi";
      leaderboard = JSON.parse(localStorage.getItem("candypaperLeaderboard")) || [];
      leaderboard = leaderboard.filter(e => e.name !== playerName);
      playerEntry = { name: playerName, score: 0, time: 0 };
      leaderboard.push(playerEntry);
      updateLeaderboardUI();
    });

    function updateLeaderboardUI() {
      const tbody = document.getElementById("leaderboardBody");
      tbody.innerHTML = "";
      leaderboard.sort((a,b) => b.score !== a.score ? b.score - a.score : a.time - b.time);
      leaderboard.forEach(entry => {
        if(leaderboard.length > 10) leaderboard = leaderboard.slice(0, 10);
        const tr = document.createElement("tr");
        if(entry.name === playerName) tr.classList.add("highlight");
        tr.innerHTML = `<td>${entry.name}</td><td>${entry.score}</td><td>${entry.time>0?entry.time:'-'}</td>`;
        tbody.appendChild(tr);
      });
      localStorage.setItem("candypaperLeaderboard", JSON.stringify(leaderboard));
    }

    function clearLeaderboard() {
      if(confirm("Haluatko varmasti tyhjent√§√§ leaderboardin?")) {
        localStorage.removeItem("candypaperLeaderboard");
        leaderboard = [];
        updateLeaderboardUI();
      }
    }

    document.addEventListener("DOMContentLoaded", () => candyCrushGame());

    function candyCrushGame() {
      const grid = document.querySelector(".grid");
      const scoreDisplay = document.getElementById("score");
      const width = 8;
      const squares = [];
      let score = 0;
      let movesLeft = 40;
      const movesDisplay = document.getElementById("moves");
      let potentialMatch = false;

      const candyColors = [
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/red-candy.png)",
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/blue-candy.png)",
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/green-candy.png)",
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/yellow-candy.png)",
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/orange-candy.png)",
        "url(https://raw.githubusercontent.com/arpit456jain/Amazing-Js-Projects/master/Candy%20Crush/utils/purple-candy.png)"
      ];

      function createBoard() {
        for(let i=0;i<width*width;i++){
          const square=document.createElement("div");
          square.setAttribute("draggable",true);
          square.setAttribute("id",i);
          square.style.backgroundImage=candyColors[Math.floor(Math.random()*candyColors.length)];
          grid.appendChild(square);
          squares.push(square);
        }
      }
      createBoard();

      let colorBeingDragged, colorBeingReplaced, squareIdBeingDragged, squareIdBeingReplaced;

      squares.forEach(sq=>{
        sq.addEventListener("dragstart", dragStart);
        sq.addEventListener("dragend", dragEnd);
        sq.addEventListener("dragover", e => e.preventDefault());
        sq.addEventListener("dragenter", e => e.preventDefault());
        sq.addEventListener("drop", dragDrop);
      });

      function dragStart(){
        colorBeingDragged = this.style.backgroundImage;
        squareIdBeingDragged = parseInt(this.id);
      }

      function dragDrop(){
        colorBeingReplaced = this.style.backgroundImage;
        squareIdBeingReplaced = parseInt(this.id);
        this.style.backgroundImage = colorBeingDragged;
        squares[squareIdBeingDragged].style.backgroundImage = colorBeingReplaced;
      }

      function dragEnd() {
        let validMoves = [
          squareIdBeingDragged-1,
          squareIdBeingDragged-width,
          squareIdBeingDragged+1,
          squareIdBeingDragged+width
        ];
        let validMove = validMoves.includes(squareIdBeingReplaced);

        if(squareIdBeingReplaced && validMove){
          if(!isMoveValid()){
            squares[squareIdBeingReplaced].style.backgroundImage=colorBeingReplaced;
            squares[squareIdBeingDragged].style.backgroundImage=colorBeingDragged;
          } else {
            movesLeft--;
            movesDisplay.innerHTML = movesLeft;
            if(score >= 200 && movesLeft > 0){
              alert("Voitit pelin! üéâ");
              movesLeft = 0;
              // save high score to Firebase
              saveHighScore(score).then(() => console.log("Score saved!"));
            } else if(movesLeft <= 0){
              alert("Peli loppui! Yrit√§ uudelleen.");
            }
          }
          squareIdBeingReplaced = null;
        } else if(squareIdBeingReplaced && !validMove){
          squares[squareIdBeingReplaced].style.backgroundImage=colorBeingReplaced;
          squares[squareIdBeingDragged].style.backgroundImage=colorBeingDragged;
        } else{
          squares[squareIdBeingDragged].style.backgroundImage=colorBeingDragged;
        }
      }

      function isMoveValid(){
        potentialMatch=false;
        checkRowMatch(true);
        checkColumnMatch(true);
        return potentialMatch;
      }

      function moveIntoSquareBelow(){
        for(let i=0;i<55;i++){
          if(squares[i+width].style.backgroundImage===""){
            squares[i+width].style.backgroundImage=squares[i].style.backgroundImage;
            squares[i].style.backgroundImage="";
            const firstRow=[0,1,2,3,4,5,6,7];
            if(firstRow.includes(i) && squares[i].style.backgroundImage===""){
              squares[i].style.backgroundImage=candyColors[Math.floor(Math.random()*candyColors.length)];
            }
          }
        }
      }

      function checkRowMatch(testOnly=false){
        for(let i=0;i<64;i++){
          let decidedColor=squares[i].style.backgroundImage;
          if(!decidedColor) continue;
          let matchCount=1;
          let rowStart=Math.floor(i/width)*width;
          for(let j=i+1;j<rowStart+width;j++){
            if(squares[j].style.backgroundImage===decidedColor) matchCount++;
            else break;
          }
          if(matchCount>=3){
            if(testOnly) potentialMatch=true;
            else {
              for(let k=0;k<matchCount;k++) squares[i+k].style.backgroundImage="";
              score+=matchCount;
              updateScore();
            }
            i+=matchCount-1;
          }
        }
      }

      function checkColumnMatch(testOnly=false){
        for(let i=0;i<64;i++){
          let decidedColor=squares[i].style.backgroundImage;
          if(!decidedColor) continue;
          let matchCount=1;
          for(let j=i+width;j<64;j+=width){
            if(squares[j].style.backgroundImage===decidedColor) matchCount++;
            else break;
          }
          if(matchCount>=3){
            if(testOnly) potentialMatch=true;
            else {
              for(let k=0;k<matchCount;k++) squares[i+k*width].style.backgroundImage="";
              score+=matchCount;
              updateScore();
            }
          }
        }
      }

      function updateScore(){
        playerEntry.score = score;
        playerEntry.time = Math.floor((Date.now()-gameStartTime)/1000);
        leaderboard = leaderboard.filter(e => e.name!==playerName);
        leaderboard.push(playerEntry);
        updateLeaderboardUI();
        scoreDisplay.innerHTML = score;

        if(score >= 200 && movesLeft > 0){
          alert("Voitit pelin! üéâ");
          movesLeft = 0;

          // Save to Firebase high score
          saveHighScore(score).then(() => console.log("Score saved!"));
        }
      }

      window.setInterval(()=>{
        moveIntoSquareBelow();
        checkRowMatch();
        checkColumnMatch();
      },100);
    }
  </script>
</body>
</html>



